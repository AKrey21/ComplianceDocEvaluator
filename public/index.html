<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LegalDoc Risk Rater</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Customizing the font family */
    body { font-family: 'Inter', sans-serif; }
    /* Hide scrollbar for aesthetics */
    ::-webkit-scrollbar { display: none; }
    /* Custom style for the overall score number in the gauge */
    #gauge text {
      transition: fill 0.5s;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-900 to-cyan-950 text-gray-100">
  <header class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-extrabold mb-1 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-sky-500">
      LegalDoc Risk Rater
    </h1>
    <p class="text-slate-400">
      AU-only compliance assessment: Australian Privacy Principles, ACSC Essential Eight, and TGA CDSS Exemption signals.
    </p>
  </header>

  <main class="max-w-6xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 pb-16">
    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 shadow-2xl h-fit sticky top-8">
      <h3 class="text-xl font-semibold mb-4 text-cyan-400">Document Upload</h3>
      <form id="fileForm" class="space-y-4">
        <input type="file" name="file" accept=".pdf,.doc,.docx,.txt" required
          class="w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:bg-slate-700 file:text-white file:font-medium hover:file:bg-slate-600 cursor-pointer transition-colors duration-200"/>
        <div class="flex items-center gap-4 pt-2">
          <button id="fileBtn" type="submit"
            class="flex-shrink-0 px-5 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-500 focus:ring-4 focus:ring-cyan-500/50 font-semibold text-white transition-colors duration-200 shadow-lg hover:shadow-cyan-500/40">
            Analyze Document
          </button>
          <span id="fileBusy" class="hidden text-sm text-cyan-300 font-medium flex items-center gap-2">
            <svg class="animate-spin h-5 w-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            Analyzing…
          </span>
        </div>
        <div id="fileErr" class="hidden text-red-300 text-sm bg-red-900/40 border border-red-700 rounded-lg p-3"></div>
      </form>

      <p id="docMeta" class="text-slate-400 mt-4 text-sm border-t border-slate-700 pt-4"></p>

      <div class="flex flex-wrap gap-2 mt-4">
        <button id="btnCopy" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Copy JSON</button>
        <button id="btnDownload" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Download JSON</button>
        <button id="btnClear" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Clear Cache</button>
      </div>
    </div>

    <div class="md:col-span-2 flex flex-col gap-8">
      <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-8 shadow-2xl flex flex-col items-center justify-center shadow-cyan-900/40 min-h-[300px]">
        <div id="gauge"></div>
        <div id="gaugeLabel" class="mt-4 text-slate-300 text-lg font-medium">Overall Risk Score</div>
        <div class="mt-2 text-xs text-slate-500 text-center">Score reflects detected wording/signals. May understate compliance if phrasing differs.</div>
      </div>

      <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 shadow-2xl">
        <h3 class="text-xl font-semibold mb-4 text-slate-200">Category Breakdown</h3>
        <div class="grid grid-cols-2 gap-4 text-sm mb-6">
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-400"></span> Privacy (APPs)</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> Security (E8)</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-400"></span> Contract fairness</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-400"></span> Vendor sharing</div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-pink-400"></span> CDSS exemption</div>
        </div>
        <div id="bars" class="space-y-3"></div>
      </div>

      <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 shadow-2xl">
        <h3 class="text-xl font-semibold mb-4 text-slate-200">Findings</h3>
        <div id="findings" class="space-y-4"></div>
        <p id="findingsEmpty" class="text-slate-500 text-sm p-4 hidden">No findings returned. This might mean the document is fully compliant based on current analysis logic, or the text extraction failed.</p>
      </div>

      <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 shadow-2xl">
        <h3 class="text-xl font-semibold mb-4 text-slate-200">Top Remediation Actions</h3>
        <div id="plan" class="space-y-4"></div>
        <p id="planEmpty" class="text-slate-500 text-sm p-4 hidden">No remediation items returned. Great work!</p>
      </div>

      <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h3 class="text-xl font-semibold text-slate-200">Executive Summary (Gemini-Ready Prompt)</h3>
          <div class="flex gap-2">
            <button id="btnGenSummary" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Regenerate</button>
            <button id="btnCopySummary" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Copy</button>
            <button id="btnDownloadSummary" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 text-sm text-slate-200 transition-colors">Download .txt</button>
          </div>
        </div>
        <textarea id="execText" class="w-full h-64 p-4 bg-slate-900 border border-slate-700 rounded-lg text-sm leading-6 font-mono text-slate-300 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all duration-200"
          placeholder="Run an analysis first, then this box will contain a Gemini-ready prompt…"></textarea>
        <p class="text-xs text-slate-500 mt-2">Tip: paste this content into Gemini and ask it to “rewrite the Privacy Policy and ToS to address these gaps,” or “draft missing clauses.”</p>
      </div>
    </div>
  </main>

<script>
let lastJson = null;

/* ----------------- helpers ----------------- */
function $(id){ return document.getElementById(id); }
function setLoading(on){
  $("fileBtn").disabled = !!on;
  $("fileBusy").classList.toggle("hidden", !on);
  $("fileBtn").classList.toggle("hidden", !!on);
}
function showError(msg){
  $("fileErr").classList.remove("hidden");
  $("fileErr").textContent = msg;
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
function severityClass(s) {
  const sev = s?.toLowerCase();
  if (sev === 'high') return 'text-red-400 font-bold';
  if (sev === 'medium') return 'text-yellow-400 font-semibold';
  if (sev === 'low') return 'text-green-400';
  return 'text-slate-400';
}

/* ----------------- overall gauge ----------------- */
function renderGauge(el, score){
  el.innerHTML='';
  const size=240, r=92, c=2*Math.PI*r;
  // Use more vibrant colors
  let colStart = '#16a34a'; // green-600
  let colEnd = '#22d3ee'; // cyan-400
  if (score < 50) {
    colStart = '#dc2626'; // red-600
    colEnd = '#f87171'; // red-400
  } else if (score < 80) {
    colStart = '#d97706'; // amber-600
    colEnd = '#facc15'; // yellow-400
  }

  const svg = `
  <svg width="${size}" height="${size}">
    <defs>
      <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="${colStart}"/>
        <stop offset="100%" stop-color="${colEnd}"/>
      </linearGradient>
    </defs>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="rgba(255,255,255,.08)" stroke-width="16" fill="none"/>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="url(#grad)" stroke-linecap="round" stroke-width="16"
      stroke-dasharray="${(Math.max(0,Math.min(100,score))/100)*c} ${c}" fill="none"
      style="transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dasharray 1s ease-out;"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="52" fill="url(#grad)" font-weight="800">${Math.round(score||0)}</text>
  </svg>`;
  el.innerHTML = svg;
}

/* ----------------- bars & sections ----------------- */
function barClass(s){return s>=80?'bg-green-400':s>=50?'bg-yellow-400':'bg-red-500'}

function renderBars(scores){
  const entries=[
    ['Privacy (APPs)','privacy_app','bg-blue-400'],
    ['Security (E8)','security_e8','bg-yellow-500'],
    ['Contract fairness','contract_fairness','bg-purple-400'],
    ['Vendor sharing','vendor_sharing','bg-green-400'],
    ['CDSS exemption','cdss_exemption','bg-pink-400'],
  ];
  const container = $("bars");
  container.innerHTML='';
  for (const [label, key, dot] of entries){
    const val = Math.max(0, Math.min(100, Number(scores[key]||0)));
    const row = document.createElement('div');
    row.className = 'bg-slate-700/50 border border-slate-700 rounded-xl p-3 hover:bg-slate-700 transition-colors duration-150';
    row.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="w-3 h-3 rounded-full ${dot}"></span>
          <span class="font-medium text-slate-200">${label}</span>
        </div>
        <span class="text-lg font-semibold ${barClass(val).replace('bg-','text-')}">${val}</span>
      </div>
      <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
        <div class="h-2 ${barClass(val)} rounded-full transition-all duration-500" style="width:${val}%"></div>
      </div>`;
    container.appendChild(row);
  }
}

function renderFindings(list){
  const container = $("findings");
  container.innerHTML='';
  $("findingsEmpty").classList.toggle("hidden", !!list.length);
  list.forEach(f=>{
    const d=document.createElement('details');
    d.className='bg-slate-700/50 border border-slate-700 rounded-xl p-4 transition-all duration-200';
    d.innerHTML=`
      <summary class="cursor-pointer flex items-center justify-between font-medium text-slate-100 hover:text-cyan-400 transition-colors duration-150">
        <span>${escapeHtml(f.title||'(untitled)')}</span>
        <span class="${severityClass(f.severity)} text-sm">${escapeHtml(f.severity||'')}</span>
      </summary>
      <div class="mt-3 text-sm text-slate-300 space-y-3 border-t border-slate-700 pt-3">
        ${f.evidence?`<div><strong>Evidence:</strong> <span class="text-slate-400">${escapeHtml(f.evidence)}</span></div>`:''}
        ${f.impact?`<div><strong>Impact:</strong> <span class="text-slate-400">${escapeHtml(f.impact)}</span></div>`:''}
        ${f.recommendation?`<div><strong>Recommendation:</strong> <span class="text-cyan-400 font-normal">${escapeHtml(f.recommendation)}</span></div>`:''}
        ${Array.isArray(f.references)&&f.references.length ? `<div class="text-slate-400">Refs: ${f.references.map(r=>`<code class="bg-slate-700/60 px-2 py-0.5 rounded text-xs">${escapeHtml(r)}</code>`).join(' ')}</div>`:''}
      </div>`;
    container.appendChild(d);
  });
}

function renderPlan(items){
  const container = $("plan");
  container.innerHTML='';
  $("planEmpty").classList.toggle("hidden", !!items.length);
  items.forEach(p=>{
    const div=document.createElement('div');
    div.className='bg-slate-700/50 border border-slate-700 rounded-xl p-4';
    div.innerHTML=`
      <div class="flex justify-between font-medium">
        <span class="text-slate-200">${escapeHtml(p.title||'Remediation')}</span>
        <span class="text-sm ${severityClass(p.severity)}">${escapeHtml(p.severity||'')}</span>
      </div>
      <div class="text-sm text-slate-400 mt-2">${escapeHtml(p.recommendation||'')}</div>`;
    container.appendChild(div);
  });
}

/* ----------------- Executive summary generator ----------------- */
function topFindings(findings, limit=6){
  const sevRank = { high:0, medium:1, low:2 };
  return (findings||[])
    .slice()
    .sort((a,b)=>(sevRank[a.severity?.toLowerCase()]??3)-(sevRank[b.severity?.toLowerCase()]??3))
    .slice(0, limit);
}

function generateExecutiveSummary(j){
  if(!j) return "Run an analysis first.";
  const s = j.scores || {};
  const cats = [
    ["Privacy (APPs)","privacy_app"],
    ["Security (E8)","security_e8"],
    ["Contract fairness","contract_fairness"],
    ["Vendor sharing","vendor_sharing"],
    ["CDSS exemption","cdss_exemption"]
  ];

  const catLines = cats.map(([label,key])=>{
    const v = Math.round(Number(s[key]||0));
    let sentiment = v>=80?"strong":v>=60?"reasonable":v>=40?"weak":"at risk";
    return `- ${label}: ${v}/100 (${sentiment})`;
  }).join("\n");

  const tf = topFindings(j.findings, 8).map(f=>{
    const sev = (f.severity||"").toUpperCase();
    const theme = (f.theme||"").replace(/_/g," ");
    return `- [${sev}] ${f.title || "(untitled)"} — theme: ${theme}. ${f.recommendation ? "Fix: "+f.recommendation : ""}`;
  }).join("\n");

  const plan = (j.remediation_plan||[]).slice(0,6).map(p=>{
    return `- (${p.severity||"medium"}) ${p.title||"Action"}: ${p.recommendation||""}`;
  }).join("\n");

  const title = j.doc?.title || "Document";
  const last = j.doc?.last_updated_detected ? ` (last updated ${j.doc.last_updated_detected})` : "";

  return `SYSTEM (context):
You are an AU-focused compliance assistant. Rewrite or augment the client's legal documents to improve alignment with:
- Australian Privacy Principles (APPs)
- ACSC Essential Eight (signals only)
- TGA CDSS Exemption conditions
Keep language plain, accurate, and non-alarmist. Do not invent facts.

CLIENT CONTEXT:
- Document: ${title}${last}
- Overall score: ${Math.round(Number(s.overall||0))}/100

CATEGORY SCORES:
${catLines}

TOP FINDINGS TO ADDRESS:
${tf || "- (no high/medium findings parsed)"}

ACTIONS / CLAUSE STARTERS (draft new/updated clauses):
${plan || "- (no remediation items parsed)"}

OUTPUT REQUEST:
1) Draft concrete clauses/sections to add or replace in the client's Privacy Policy and/or Terms, referencing APPs/E8/CDSS exemption where relevant.
2) Keep it AU jurisdiction-aware and self-contained.
3) Include brief rationale lines after each clause (// why).
4) Provide a short checklist we can paste back into the app to verify coverage.`;
}

/* ----------------- show + cache ----------------- */
function showReport(j){
  lastJson = j;
  try { localStorage.setItem("riskReport", JSON.stringify(j)); } catch(e) {}

  const m=j.doc||{};
  $("docMeta").textContent = `${m.title||'Document'} • AU-only ${m.last_updated_detected?('• last updated: '+m.last_updated_detected):''}`;

  const s=j.scores||{};
  renderGauge($("gauge"), Number(s.overall||0));
  renderBars(s);
  renderFindings(j.findings||[]);
  renderPlan(j.remediation_plan||[]);

  // Executive summary
  $("execText").value = generateExecutiveSummary(j);
}

/* ----------------- upload flow ----------------- */
$("fileForm").addEventListener('submit', async (e)=>{
  e.preventDefault(); $("fileErr").classList.add("hidden"); setLoading(true);
  try{
    const fd=new FormData($("fileForm"));
    const r=await fetch('/api/analyze-file',{method:'POST',body:fd});
    const j=await r.json().catch(()=>({error:'Invalid JSON from server'}));
    if(!r.ok){ showError(j.error||(`${r.status} ${r.statusText}`)); return; }
    showReport(j);
  }catch(err){ showError(String(err)); }
  finally{ setLoading(false); }
});

/* ----------------- copy/download/clear ----------------- */
$("btnCopy").addEventListener('click',()=>{
  if(!lastJson) return; navigator.clipboard.writeText(JSON.stringify(lastJson,null,2));
});
$("btnDownload").addEventListener('click',()=>{
  if(!lastJson) return;
  const blob=new Blob([JSON.stringify(lastJson,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='risk-report.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
});
$("btnClear").addEventListener('click',()=>{
  try { localStorage.removeItem("riskReport"); } catch(e) {}
  lastJson = null;
  $("docMeta").textContent = '';
  $("gauge").innerHTML = '';
  $("bars").innerHTML = '';
  $("findings").innerHTML = '';
  $("plan").innerHTML = '';
  $("execText").value = '';
  $("findingsEmpty").classList.add("hidden");
  $("planEmpty").classList.add("hidden");
  // Also hide the primary button and show the analysis button if it was hidden
  setLoading(false);
});

/* ----------------- exec summary controls ----------------- */
$("btnGenSummary").addEventListener('click', ()=>{
  if(!lastJson) return;
  $("execText").value = generateExecutiveSummary(lastJson);
});
$("btnCopySummary").addEventListener('click', ()=>{
  if(!$("execText").value) return;
  navigator.clipboard.writeText($("execText").value);
});
$("btnDownloadSummary").addEventListener('click', ()=>{
  if(!$("execText").value) return;
  const blob=new Blob([$("execText").value],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='executive-summary.txt'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
});

function renderFindings(list){
  const container = $("findings");
  container.innerHTML='';
  $("findingsEmpty").classList.toggle("hidden", !!list.length);
  list.forEach(f=>{
    const d=document.createElement('details');
    d.className='bg-slate-700/50 border border-slate-700 rounded-xl p-4 transition-all duration-200';
    d.innerHTML=`
      <summary class="cursor-pointer flex items-center justify-between font-medium text-slate-100 hover:text-cyan-400 transition-colors duration-150">
        <span>${escapeHtml(f.title||'(untitled)')}</span>
        <span class="${severityClass(f.severity)} text-sm">${escapeHtml(f.severity||'')}</span>
      </summary>
      <div class="mt-3 text-sm text-slate-300 space-y-3 border-t border-slate-700 pt-3">
        ${f.evidence?`<div><strong>Evidence:</strong> <span class="text-slate-400">
            ${escapeHtml(f.evidence).replace(/(\[LINE\s\d+\])/g, '<code class="text-pink-400 font-mono text-xs px-1.5 py-0.5 rounded bg-slate-800/80">$1</code>')}
        </span></div>`:''}
        ${f.impact?`<div><strong>Impact:</strong> <span class="text-slate-400">${escapeHtml(f.impact)}</span></div>`:''}
        ${f.recommendation?`<div><strong>Recommendation:</strong> <span class="text-cyan-400 font-normal">${escapeHtml(f.recommendation)}</span></div>`:''}
        ${Array.isArray(f.references)&&f.references.length ? `<div class="text-slate-400">Refs: ${f.references.map(r=>`<code class="bg-slate-700/60 px-2 py-0.5 rounded text-xs">${escapeHtml(r)}</code>`).join(' ')}</div>`:''}
      </div>`;
    container.appendChild(d);
  });
}

/* ----------------- load cached on boot ----------------- */
(function restoreCache(){
  const cached = localStorage.getItem("riskReport");
  if (!cached) return;
  try { showReport(JSON.parse(cached)); } catch(e) { console.warn("Invalid cached report", e); }
})();
</script>
</body>
</html>